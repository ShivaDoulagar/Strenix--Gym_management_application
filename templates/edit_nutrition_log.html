{% extends 'layout.html' %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Edit Nutrition Log</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_nutrition_log', id=log.id) }}">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" value="{{ log.date.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="meal" class="form-label">Meal Type</label>
                                <select class="form-select" id="meal" name="meal" required>
                                    <option value="Breakfast" {% if log.meal == 'Breakfast' %}selected{% endif %}>Breakfast</option>
                                    <option value="Lunch" {% if log.meal == 'Lunch' %}selected{% endif %}>Lunch</option>
                                    <option value="Dinner" {% if log.meal == 'Dinner' %}selected{% endif %}>Dinner</option>
                                    <option value="Snack" {% if log.meal == 'Snack' %}selected{% endif %}>Snack</option>
                                    <option value="Pre-workout" {% if log.meal == 'Pre-workout' %}selected{% endif %}>Pre-workout</option>
                                    <option value="Post-workout" {% if log.meal == 'Post-workout' %}selected{% endif %}>Post-workout</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="calories" class="form-label">Calories</label>
                                <div class="input-group">
                                    <input type="number" step="0.1" min="0" class="form-control" id="calories" name="calories" value="{{ log.calories }}" required>
                                    <span class="input-group-text">kcal</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="protein" class="form-label">Protein</label>
                                <div class="input-group">
                                    <input type="number" step="0.1" min="0" class="form-control" id="protein" name="protein" value="{{ log.protein }}" required>
                                    <span class="input-group-text">g</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="carbs" class="form-label">Carbohydrates</label>
                                <div class="input-group">
                                    <input type="number" step="0.1" min="0" class="form-control" id="carbs" name="carbs" value="{{ log.carbs }}" required>
                                    <span class="input-group-text">g</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="fats" class="form-label">Fats</label>
                                <div class="input-group">
                                    <input type="number" step="0.1" min="0" class="form-control" id="fats" name="fats" value="{{ log.fats }}" required>
                                    <span class="input-group-text">g</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add any details about this meal...">{{ log.notes if log.notes else '' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- Macronutrient Balance Visualization -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Macronutrient Balance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="progress" style="height: 25px;">
                                            <div id="protein-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            <div id="carbs-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            <div id="fats-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small><span class="badge bg-success">Protein</span></small>
                                            <small><span class="badge bg-info">Carbs</span></small>
                                            <small><span class="badge bg-warning">Fats</span></small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mt-3 mt-md-0">
                                            <p class="mb-1"><small>Protein: <span id="protein-percent">0</span>% (<span id="protein-calories">0</span> kcal)</small></p>
                                            <p class="mb-1"><small>Carbs: <span id="carbs-percent">0</span>% (<span id="carbs-calories">0</span> kcal)</small></p>
                                            <p class="mb-1"><small>Fats: <span id="fats-percent">0</span>% (<span id="fats-calories">0</span> kcal)</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calorie Comparison to Target -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Calorie Goal Progress</h5>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="progress" style="height: 25px;">
                                            <div id="calorie-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2">
                                            <small>0 kcal</small>
                                            <small>{{ current_user.daily_calorie_goal if current_user.daily_calorie_goal else 2000 }} kcal</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mt-3 mt-md-0 text-center">
                                            <span id="calories-display">0</span> / 
                                            <span>{{ current_user.daily_calorie_goal if current_user.daily_calorie_goal else 2000 }}</span> kcal
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('nutrition_logs') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Logs
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                                <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="fas fa-trash-alt me-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this nutrition log from {{ log.date.strftime('%b %d, %Y') }}?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_nutrition_log', id=log.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // References to input elements
        const proteinInput = document.getElementById('protein');
        const carbsInput = document.getElementById('carbs');
        const fatsInput = document.getElementById('fats');
        const caloriesInput = document.getElementById('calories');
        
        // References to display elements
        const proteinBar = document.getElementById('protein-bar');
        const carbsBar = document.getElementById('carbs-bar');
        const fatsBar = document.getElementById('fats-bar');
        const proteinPercent = document.getElementById('protein-percent');
        const carbsPercent = document.getElementById('carbs-percent');
        const fatsPercent = document.getElementById('fats-percent');
        const proteinCalories = document.getElementById('protein-calories');
        const carbsCalories = document.getElementById('carbs-calories');
        const fatsCalories = document.getElementById('fats-calories');
        const calorieProgress = document.getElementById('calorie-progress');
        const caloriesDisplay = document.getElementById('calories-display');
        
        // Calorie constants for macronutrients
        const PROTEIN_CAL_PER_GRAM = 4;
        const CARBS_CAL_PER_GRAM = 4;
        const FATS_CAL_PER_GRAM = 9;
        
        // Daily calorie goal (from user profile or default)
        const dailyCalorieGoal = {{ current_user.daily_calorie_goal if current_user.daily_calorie_goal else 2000 }};
        
        // Function to update the macronutrient balance visualization
        function updateMacroBalance() {
            // Get values from inputs
            const protein = parseFloat(proteinInput.value) || 0;
            const carbs = parseFloat(carbsInput.value) || 0;
            const fats = parseFloat(fatsInput.value) || 0;
            
            // Calculate calories from each macronutrient
            const proteinCal = protein * PROTEIN_CAL_PER_GRAM;
            const carbsCal = carbs * CARBS_CAL_PER_GRAM;
            const fatsCal = fats * FATS_CAL_PER_GRAM;
            
            // Calculate total calories
            const totalCal = proteinCal + carbsCal + fatsCal;
            
            // Update calories input if it doesn't match calculated value
            if (Math.abs(parseFloat(caloriesInput.value) - totalCal) > 1) {
                caloriesInput.value = totalCal.toFixed(1);
            }
            
            // Calculate percentages
            const proteinPct = totalCal > 0 ? (proteinCal / totalCal) * 100 : 0;
            const carbsPct = totalCal > 0 ? (carbsCal / totalCal) * 100 : 0;
            const fatsPct = totalCal > 0 ? (fatsCal / totalCal) * 100 : 0;
            
            // Update progress bars
            proteinBar.style.width = proteinPct + '%';
            proteinBar.textContent = Math.round(proteinPct) + '%';
            carbsBar.style.width = carbsPct + '%';
            carbsBar.textContent = Math.round(carbsPct) + '%';
            fatsBar.style.width = fatsPct + '%';
            fatsBar.textContent = Math.round(fatsPct) + '%';
            
            // Update text percentages
            proteinPercent.textContent = Math.round(proteinPct);
            carbsPercent.textContent = Math.round(carbsPct);
            fatsPercent.textContent = Math.round(fatsPct);
            
            // Update calorie values
            proteinCalories.textContent = Math.round(proteinCal);
            carbsCalories.textContent = Math.round(carbsCal);
            fatsCalories.textContent = Math.round(fatsCal);
            
            // Update calorie goal progress
            const caloriePct = (totalCal / dailyCalorieGoal) * 100;
            calorieProgress.style.width = Math.min(caloriePct, 100) + '%';
            calorieProgress.textContent = Math.round(caloriePct) + '%';
            caloriesDisplay.textContent = Math.round(totalCal);
            
            // Change color of calorie progress bar based on percentage
            if (caloriePct > 110) {
                calorieProgress.classList.remove('bg-primary', 'bg-warning');
                calorieProgress.classList.add('bg-danger');
            } else if (caloriePct > 90) {
                calorieProgress.classList.remove('bg-primary', 'bg-danger');
                calorieProgress.classList.add('bg-warning');
            } else {
                calorieProgress.classList.remove('bg-warning', 'bg-danger');
                calorieProgress.classList.add('bg-primary');
            }
        }
        
        // Add event listeners to update visualization when inputs change
        proteinInput.addEventListener('input', updateMacroBalance);
        carbsInput.addEventListener('input', updateMacroBalance);
        fatsInput.addEventListener('input', updateMacroBalance);
        caloriesInput.addEventListener('input', function() {
            // If user manually changes calories, don't recompute from macros
            // Just update the progress bar
            const calories = parseFloat(caloriesInput.value) || 0;
            const caloriePct = (calories / dailyCalorieGoal) * 100;
            calorieProgress.style.width = Math.min(caloriePct, 100) + '%';
            calorieProgress.textContent = Math.round(caloriePct) + '%';
            caloriesDisplay.textContent = Math.round(calories);
        });
        
        // Run once on page load to initialize
        updateMacroBalance();
    });
</script>
{% endblock %}